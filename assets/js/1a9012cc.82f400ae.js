"use strict";(self.webpackChunkmy_website=self.webpackChunkmy_website||[]).push([[2785],{9940:(e,s,r)=>{r.r(s),r.d(s,{assets:()=>a,contentTitle:()=>c,default:()=>p,frontMatter:()=>i,metadata:()=>f,toc:()=>o});var n=r(4848),t=r(8453);const i={},c="SPIFFS Filesystem",f={id:"espressif/\u4e2a\u4eba\u5b66\u4e60/IDF/spiffs",title:"SPIFFS Filesystem",description:"1.\u5de5\u7a0b\u6784\u5efa",source:"@site/docs/espressif/\u4e2a\u4eba\u5b66\u4e60/IDF/spiffs.md",sourceDirName:"espressif/\u4e2a\u4eba\u5b66\u4e60/IDF",slug:"/espressif/\u4e2a\u4eba\u5b66\u4e60/IDF/spiffs",permalink:"/docs/espressif/\u4e2a\u4eba\u5b66\u4e60/IDF/spiffs",draft:!1,unlisted:!1,editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/espressif/\u4e2a\u4eba\u5b66\u4e60/IDF/spiffs.md",tags:[],version:"current",frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"protobuf",permalink:"/docs/espressif/\u4e2a\u4eba\u5b66\u4e60/IDF/protobuf"},next:{title:"ST7789 and lvgl",permalink:"/docs/espressif/\u4e2a\u4eba\u5b66\u4e60/IDF/st7789v"}},a={},o=[{value:"1.\u5de5\u7a0b\u6784\u5efa",id:"1\u5de5\u7a0b\u6784\u5efa",level:3},{value:"1.1 \u6dfb\u52a0\u5206\u533a\u8868 partitions.csv",id:"11-\u6dfb\u52a0\u5206\u533a\u8868-partitionscsv",level:4},{value:"1.2 \u6dfb\u52a0sdkconfig.defaults",id:"12-\u6dfb\u52a0sdkconfigdefaults",level:4},{value:"1.3 \u5728project\u7684cmakelist\u6dfb\u52a0",id:"13-\u5728project\u7684cmakelist\u6dfb\u52a0",level:4},{value:"2.\u8bfb\u5199\u6587\u4ef6\u5de5\u7a0b",id:"2\u8bfb\u5199\u6587\u4ef6\u5de5\u7a0b",level:3},{value:"Ref",id:"ref",level:2}];function l(e){const s={code:"code",h1:"h1",h2:"h2",h3:"h3",h4:"h4",p:"p",pre:"pre",...(0,t.R)(),...e.components};return(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)(s.h1,{id:"spiffs-filesystem",children:"SPIFFS Filesystem"}),"\n",(0,n.jsx)(s.h3,{id:"1\u5de5\u7a0b\u6784\u5efa",children:"1.\u5de5\u7a0b\u6784\u5efa"}),"\n",(0,n.jsx)(s.h4,{id:"11-\u6dfb\u52a0\u5206\u533a\u8868-partitionscsv",children:"1.1 \u6dfb\u52a0\u5206\u533a\u8868 partitions.csv"}),"\n",(0,n.jsx)(s.pre,{children:(0,n.jsx)(s.code,{className:"language-csv",children:"# Name,   Type, SubType, Offset,  Size, Flags\r\n# Note: if you have increased the bootloader size, make sure to update the offsets to avoid overlap\r\nnvs,      data, nvs,     0x9000,  0x6000,\r\nphy_init, data, phy,     0xf000,  0x1000,\r\nfactory,  app,  factory, 0x10000, 1M,\r\nstorage,  data, spiffs,  ,        0xF0000,\n"})}),"\n",(0,n.jsx)(s.p,{children:"\u5176\u4e2dstorge\u5206\u533a\u5c31\u662f\u6211\u4eec\u5b58\u50a8\u6570\u636e\u7684\u5730\u65b9"}),"\n",(0,n.jsx)(s.h4,{id:"12-\u6dfb\u52a0sdkconfigdefaults",children:"1.2 \u6dfb\u52a0sdkconfig.defaults"}),"\n",(0,n.jsx)(s.pre,{children:(0,n.jsx)(s.code,{children:'CONFIG_PARTITION_TABLE_CUSTOM=y\r\nCONFIG_PARTITION_TABLE_CUSTOM_FILENAME="partitions.csv"\r\nCONFIG_PARTITION_TABLE_FILENAME="partitions.csv"\n'})}),"\n",(0,n.jsx)(s.p,{children:"\u4f7f\u7528idf.py set-target xxx\u8ba9\u9ed8\u8ba4\u914d\u7f6e\u751f\u6548"}),"\n",(0,n.jsx)(s.h4,{id:"13-\u5728project\u7684cmakelist\u6dfb\u52a0",children:"1.3 \u5728project\u7684cmakelist\u6dfb\u52a0"}),"\n",(0,n.jsx)(s.pre,{children:(0,n.jsx)(s.code,{className:"language-cmake",children:"cmake_minimum_required(VERSION 3.5)\r\n\r\ninclude($ENV{IDF_PATH}/tools/cmake/project.cmake)\r\nproject(esp_usb_otg)\r\n\r\nspiffs_create_partition_image(storage src FLASH_IN_PROJECT)\n"})}),"\n",(0,n.jsx)(s.p,{children:"\u5176\u4e2dsrc\u5c31\u662f\u6211\u4eec\u5b58\u653e\u7684\u76ee\u5f55"}),"\n",(0,n.jsx)(s.h3,{id:"2\u8bfb\u5199\u6587\u4ef6\u5de5\u7a0b",children:"2.\u8bfb\u5199\u6587\u4ef6\u5de5\u7a0b"}),"\n",(0,n.jsx)(s.p,{children:"\u5173\u952e\u51fd\u6570\uff1a"}),"\n",(0,n.jsx)(s.pre,{children:(0,n.jsx)(s.code,{className:"language-c",children:"//\u6ce8\u518cspiffs\r\nesp_err_t esp_vfs_spiffs_register(const esp_vfs_spiffs_conf_t * conf);\r\n//\u6ce8\u9500spiffs\r\nesp_err_t esp_vfs_spiffs_unregister(const char* partition_label);\r\n//spiffs\u68c0\u67e5\r\nesp_err_t esp_spiffs_check(const char* partition_label); \r\n//\u83b7\u53d6\u4f7f\u7528\u60c5\u51b5\r\nesp_err_t esp_spiffs_info(const char* partition_label, size_t *total_bytes, size_t *used_bytes)\uff1b\n"})}),"\n",(0,n.jsx)(s.p,{children:"\u5b8c\u6574\u5de5\u7a0b"}),"\n",(0,n.jsx)(s.pre,{children:(0,n.jsx)(s.code,{className:"language-c",children:'#include <stdio.h>\r\n#include <string.h>\r\n#include <sys/unistd.h>\r\n#include <sys/stat.h>\r\n#include "esp_err.h"\r\n#include "esp_log.h"\r\n#include "esp_spiffs.h"\r\n\r\nstatic const char *TAG = "USB_OTG";\r\n\r\nvoid app_main(void)\r\n{\r\n    esp_err_t ret;\r\n    esp_vfs_spiffs_conf_t conf = {\r\n        .base_path = "/spiffs",\r\n        .partition_label = NULL,\r\n        .max_files = 5,\r\n        .format_if_mount_failed = true, // \u5982\u679c\u6302\u8f7d\u5931\u8d25\uff0c\u5c06\u683c\u5f0f\u5316\u6587\u4ef6\u7cfb\u7edf\r\n    };\r\n\r\n    ESP_ERROR_CHECK(esp_vfs_spiffs_register(&conf));\r\n\r\n    // \u68c0\u67e5spiffs\r\n    ret = esp_spiffs_check(conf.partition_label);\r\n    if (ret != ESP_OK)\r\n    {\r\n        ESP_LOGI(TAG, "SPIFFS Check failed:%s", esp_err_to_name(ret));\r\n    }\r\n    else\r\n    {\r\n        ESP_LOGI(TAG, "SPIFFS Check success");\r\n    }\r\n\r\n    // \u83b7\u53d6spiffs\u7684\u4fe1\u606f\r\n    size_t total = 0, used = 0;\r\n    ret = esp_spiffs_info(conf.partition_label, &total, &used);\r\n    if (ret != ESP_OK)\r\n    {\r\n        ESP_LOGI(TAG, "Failed to get spiffs partition info:%s", esp_err_to_name(ret));\r\n    }\r\n    else\r\n    {\r\n        ESP_LOGI(TAG, "Partition size: total:%d,used:%d ", total, used);\r\n    }\r\n\r\n    // \u5982\u679cused > total\uff0c\u518d\u6b21\u68c0\u67e5\r\n    if (used > total)\r\n    {\r\n        ESP_LOGW(TAG, "Number of used bytes cannot be larger than total. Performing SPIFFS_check().");\r\n        ret = esp_spiffs_check(conf.partition_label);\r\n        if (ret != ESP_OK)\r\n        {\r\n            ESP_LOGE(TAG, "SPIFFS_check() failed (%s)", esp_err_to_name(ret));\r\n            return;\r\n        }\r\n        else\r\n        {\r\n            ESP_LOGI(TAG, "SPIFFS_check() successful");\r\n        }\r\n    }\r\n\r\n    // \u5199\u6587\u4ef6 \u6211\u5e0c\u671b\u5728\u539f\u6709\u7684\u6587\u4ef6\u540e\u9762\u8ffd\u52a0\uff0c\u6240\u4ee5\u7528a\r\n    FILE *f = fopen("/spiffs/hello.txt", "a");\r\n    if (f == NULL)\r\n    {\r\n        ESP_LOGE(TAG, "Open file failed");\r\n        return;\r\n    }\r\n    const char *content = " yanke";\r\n    fputs(content, f);\r\n    fclose(f);\r\n\r\n    // \u8bfb\u53d6\u6587\u4ef6\r\n    f = fopen("/spiffs/hello.txt", "r");\r\n    if (f == NULL)\r\n    {\r\n        ESP_LOGE(TAG, "Open file failed");\r\n        return;\r\n    }\r\n\r\n    char buf[256];\r\n    fread(buf, 1, sizeof(buf), f);\r\n    ESP_LOGI(TAG, "%s", buf);\r\n    fclose(f);\r\n\r\n    esp_vfs_spiffs_unregister(conf.partition_label);\r\n}\n'})}),"\n",(0,n.jsx)(s.h2,{id:"ref",children:"Ref"})]})}function p(e={}){const{wrapper:s}={...(0,t.R)(),...e.components};return s?(0,n.jsx)(s,{...e,children:(0,n.jsx)(l,{...e})}):l(e)}},8453:(e,s,r)=>{r.d(s,{R:()=>c,x:()=>f});var n=r(6540);const t={},i=n.createContext(t);function c(e){const s=n.useContext(i);return n.useMemo((function(){return"function"==typeof e?e(s):{...s,...e}}),[s,e])}function f(e){let s;return s=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:c(e.components),n.createElement(i.Provider,{value:s},e.children)}}}]);