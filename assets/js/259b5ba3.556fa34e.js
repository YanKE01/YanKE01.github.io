"use strict";(self.webpackChunkmy_website=self.webpackChunkmy_website||[]).push([[9464],{4155:(e,n,r)=>{r.r(n),r.d(n,{assets:()=>t,contentTitle:()=>l,default:()=>d,frontMatter:()=>c,metadata:()=>s,toc:()=>p});var _=r(4848),i=r(8453);const c={},l="i2c \u9891\u7387\u95ee\u9898",s={id:"espressif/\u5ba2\u6237\u652f\u6301/i2c/i2c_frequency",title:"i2c \u9891\u7387\u95ee\u9898",description:"\u95ee\u9898\u63cf\u8ff0\uff1a",source:"@site/docs/espressif/\u5ba2\u6237\u652f\u6301/i2c/i2c_frequency.md",sourceDirName:"espressif/\u5ba2\u6237\u652f\u6301/i2c",slug:"/espressif/\u5ba2\u6237\u652f\u6301/i2c/i2c_frequency",permalink:"/docs/espressif/\u5ba2\u6237\u652f\u6301/i2c/i2c_frequency",draft:!1,unlisted:!1,editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/espressif/\u5ba2\u6237\u652f\u6301/i2c/i2c_frequency.md",tags:[],version:"current",frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"ADC\u5b9a\u65f6\u626b\u63cf",permalink:"/docs/espressif/\u5ba2\u6237\u652f\u6301/adc/adc\u5b9a\u65f6\u626b\u63cf"},next:{title:"uart flush input \u4e2d\u7684 rx_buffered_len error",permalink:"/docs/espressif/\u5ba2\u6237\u652f\u6301/uart/flush_input"}},t={},p=[{value:"\u6d4b\u8bd5\u8fc7\u7a0b",id:"\u6d4b\u8bd5\u8fc7\u7a0b",level:2},{value:"CLK\u9891\u7387\u6ce2\u5f62\u5206\u6790",id:"clk\u9891\u7387\u6ce2\u5f62\u5206\u6790",level:3},{value:"\u4e0d\u540cIDF\u7248\u672c\u95ee\u9898\u662f\u5426\u590d\u73b0",id:"\u4e0d\u540cidf\u7248\u672c\u95ee\u9898\u662f\u5426\u590d\u73b0",level:3},{value:"\u95ee\u9898\u6392\u67e5\uff1a",id:"\u95ee\u9898\u6392\u67e5",level:3},{value:"\u89e3\u51b3\u8fc7\u7a0b\uff1a",id:"\u89e3\u51b3\u8fc7\u7a0b",level:2}];function a(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",img:"img",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,i.R)(),...e.components};return(0,_.jsxs)(_.Fragment,{children:[(0,_.jsx)(n.h1,{id:"i2c-\u9891\u7387\u95ee\u9898",children:"i2c \u9891\u7387\u95ee\u9898"}),"\n",(0,_.jsx)(n.p,{children:"\u95ee\u9898\u63cf\u8ff0\uff1a"}),"\n",(0,_.jsx)(n.p,{children:(0,_.jsx)(n.img,{src:r(8270).A+"",width:"1444",height:"716"})}),"\n",(0,_.jsx)(n.h2,{id:"\u6d4b\u8bd5\u8fc7\u7a0b",children:"\u6d4b\u8bd5\u8fc7\u7a0b"}),"\n",(0,_.jsx)(n.p,{children:"\u6d4b\u8bd5\u4ee3\u7801\uff1a"}),"\n",(0,_.jsx)(n.pre,{children:(0,_.jsx)(n.code,{className:"language-c",children:'#include <stdio.h>\r\n#include "driver/i2c.h"\r\n#include "freertos/FreeRTOS.h"\r\n#include "freertos/task.h"\r\n\r\n#define I2C_EXT_SDA_GPIO 14\r\n#define I2C_EXT_SCL_GPIO 21\r\n#define I2C_EXT_SPEED 5000\r\n#define EXTERNAL_I2C_CHANNEL I2C_NUM_0\r\n#define CELL_ADC_ADDR 0x48\r\n\r\nvoid app_main(void)\r\n{\r\n    const i2c_config_t conf0 = {\r\n        .mode = I2C_MODE_MASTER,\r\n        .sda_io_num = I2C_EXT_SDA_GPIO,\r\n        .scl_io_num = I2C_EXT_SCL_GPIO,\r\n        .sda_pullup_en = GPIO_PULLUP_DISABLE,\r\n        .scl_pullup_en = GPIO_PULLUP_DISABLE,\r\n        .master.clk_speed = I2C_EXT_SPEED,\r\n        .clk_flags = 0,\r\n    };\r\n    i2c_param_config(EXTERNAL_I2C_CHANNEL, &conf0);\r\n    i2c_driver_install(EXTERNAL_I2C_CHANNEL, conf0.mode, 0, 0, 0);\r\n\r\n    while (1)\r\n    {\r\n        uint8_t buf[3];\r\n        buf[0] = 1;\r\n        buf[1] = 0XCC;\r\n        buf[2] = 0x5A;\r\n        esp_err_t res = i2c_master_write_to_device(I2C_NUM_0, CELL_ADC_ADDR, buf, 3, 10);\r\n        vTaskDelay(1);\r\n    }\r\n}\r\n\r\n\n'})}),"\n",(0,_.jsx)(n.h3,{id:"clk\u9891\u7387\u6ce2\u5f62\u5206\u6790",children:"CLK\u9891\u7387\u6ce2\u5f62\u5206\u6790"}),"\n",(0,_.jsx)(n.p,{children:"\u5728I2C\u5199\u7684\u521d\u671f\u9636\u6bb5\uff0cCLK\u7684\u9891\u7387\u786e\u5b9e\u662f\u4ee55Khz\u8fdb\u884c\u7684\uff1a"}),"\n",(0,_.jsx)(n.p,{children:(0,_.jsx)(n.img,{src:r(8557).A+"",width:"1018",height:"225"})}),"\n",(0,_.jsx)(n.p,{children:"\u5f53\u6a21\u62df\u4ece\u673a\u5173\u95ed\u540e\uff0c\u518d\u8d77\u5f00\u542f\u4ece\u673a\u540e\uff0cclk\u7684\u9891\u7387\u53d8\u5316\u4e3a40Khz\uff0c\u4e0e\u5ba2\u6237\u73b0\u8c61\u4fdd\u6301\u4e00\u81f4\uff1a"}),"\n",(0,_.jsx)(n.p,{children:(0,_.jsx)(n.img,{src:r(5406).A+"",width:"1443",height:"352"})}),"\n",(0,_.jsx)(n.h3,{id:"\u4e0d\u540cidf\u7248\u672c\u95ee\u9898\u662f\u5426\u590d\u73b0",children:"\u4e0d\u540cIDF\u7248\u672c\u95ee\u9898\u662f\u5426\u590d\u73b0"}),"\n",(0,_.jsxs)(n.ul,{children:["\n",(0,_.jsx)(n.li,{children:"idf master: \u672a\u590d\u73b0"}),"\n",(0,_.jsx)(n.li,{children:"idf release V5.2\uff1a\u672a\u590d\u73b0"}),"\n"]}),"\n",(0,_.jsx)(n.h3,{id:"\u95ee\u9898\u6392\u67e5",children:"\u95ee\u9898\u6392\u67e5\uff1a"}),"\n",(0,_.jsxs)(n.p,{children:["\u5f53\u4ece\u673a\u65ad\u5f00\u8fde\u63a5\u7684\u65f6\u5019\uff0c\u4f1a\u89e6\u53d1",(0,_.jsx)(n.code,{children:"i2c_hw_disable"}),"\u7684\u64cd\u4f5c\uff0c\u5728\u91cc\u9762\u540c\u6b65\u89e6\u53d1",(0,_.jsx)(n.code,{children:"periph_module_disable"}),"\u7684\u64cd\u4f5c\uff1a"]}),"\n",(0,_.jsx)(n.pre,{children:(0,_.jsx)(n.code,{className:"language-c",children:"static inline void periph_ll_disable_clk_set_rst(periph_module_t periph)\r\n{\r\n    DPORT_CLEAR_PERI_REG_MASK(periph_ll_get_clk_en_reg(periph), periph_ll_get_clk_en_mask(periph));\r\n    DPORT_SET_PERI_REG_MASK(periph_ll_get_rst_en_reg(periph), periph_ll_get_rst_en_mask(periph, false));\r\n}\n"})}),"\n",(0,_.jsxs)(n.p,{children:["\u540c\u65f6\uff0c\u5728 ",(0,_.jsx)(n.strong,{children:"V5.1.2"})," \u4e2d\uff0chw\u7684disable\u548cenable\u662f\u5206\u5f00\u7684\uff0c\u5206\u522b\u5bf9\u5e94\u5982\u4e0b\uff1a"]}),"\n",(0,_.jsx)(n.pre,{children:(0,_.jsx)(n.code,{className:"language-c",children:"static void i2c_hw_disable(i2c_port_t i2c_num)\r\n{\r\n    I2C_ENTER_CRITICAL(&(i2c_context[i2c_num].spinlock));\r\n    if (i2c_context[i2c_num].hw_enabled != false) {\r\n        periph_module_disable(i2c_periph_signal[i2c_num].module);\r\n        i2c_context[i2c_num].hw_enabled = false;\r\n    }\r\n    I2C_EXIT_CRITICAL(&(i2c_context[i2c_num].spinlock));\r\n}\r\n\r\nstatic void i2c_hw_enable(i2c_port_t i2c_num)\r\n{\r\n    I2C_ENTER_CRITICAL(&(i2c_context[i2c_num].spinlock));\r\n    if (i2c_context[i2c_num].hw_enabled != true) {\r\n        periph_module_enable(i2c_periph_signal[i2c_num].module);\r\n        i2c_context[i2c_num].hw_enabled = true;\r\n    }\r\n    I2C_EXIT_CRITICAL(&(i2c_context[i2c_num].spinlock));\r\n}\r\n\r\n\r\nvoid periph_module_enable(periph_module_t periph)\r\n{\r\n    assert(periph < PERIPH_MODULE_MAX);\r\n    portENTER_CRITICAL_SAFE(&periph_spinlock);\r\n    if (ref_counts[periph] == 0) {\r\n        periph_ll_enable_clk_clear_rst(periph);\r\n    }\r\n    ref_counts[periph]++;\r\n    portEXIT_CRITICAL_SAFE(&periph_spinlock);\r\n}\r\n\r\nvoid periph_module_disable(periph_module_t periph)\r\n{\r\n    assert(periph < PERIPH_MODULE_MAX);\r\n    portENTER_CRITICAL_SAFE(&periph_spinlock);\r\n    ref_counts[periph]--;\r\n    if (ref_counts[periph] == 0) {\r\n        periph_ll_disable_clk_set_rst(periph);\r\n    }\r\n    portEXIT_CRITICAL_SAFE(&periph_spinlock);\r\n}\r\n\r\nstatic inline void periph_ll_enable_clk_clear_rst(periph_module_t periph)\r\n{\r\n    DPORT_SET_PERI_REG_MASK(periph_ll_get_clk_en_reg(periph), periph_ll_get_clk_en_mask(periph));\r\n    DPORT_CLEAR_PERI_REG_MASK(periph_ll_get_rst_en_reg(periph), periph_ll_get_rst_en_mask(periph, true));\r\n}\r\n\r\nstatic inline void periph_ll_disable_clk_set_rst(periph_module_t periph)\r\n{\r\n    DPORT_CLEAR_PERI_REG_MASK(periph_ll_get_clk_en_reg(periph), periph_ll_get_clk_en_mask(periph));\r\n    DPORT_SET_PERI_REG_MASK(periph_ll_get_rst_en_reg(periph), periph_ll_get_rst_en_mask(periph, false));\r\n}\r\n\r\n\n"})}),"\n",(0,_.jsx)(n.p,{children:"\u4f46\u662f\uff0c\u5728V5.2\u7684\u7248\u672c\u4e2d\uff0cdisable\u548cenable\u662f\u4e00\u4e2a\u64cd\u4f5c\uff0c\u5bf9\u5e94\uff1a"}),"\n",(0,_.jsx)(n.pre,{children:(0,_.jsx)(n.code,{className:"language-c",children:"static void i2c_hw_disable(i2c_port_t i2c_num)\r\n{\r\n    I2C_ENTER_CRITICAL(&(i2c_context[i2c_num].spinlock));\r\n    if (i2c_context[i2c_num].hw_enabled != false) {\r\n        I2C_RCC_ATOMIC() {\r\n            i2c_ll_enable_bus_clock(i2c_num, false);\r\n        }\r\n        i2c_context[i2c_num].hw_enabled = false;\r\n    }\r\n    I2C_EXIT_CRITICAL(&(i2c_context[i2c_num].spinlock));\r\n}\r\n\r\nstatic void i2c_hw_enable(i2c_port_t i2c_num)\r\n{\r\n    I2C_ENTER_CRITICAL(&(i2c_context[i2c_num].spinlock));\r\n    if (i2c_context[i2c_num].hw_enabled != true) {\r\n        I2C_RCC_ATOMIC() {\r\n            i2c_ll_enable_bus_clock(i2c_num, true);\r\n            i2c_ll_reset_register(i2c_num);\r\n        }\r\n        i2c_context[i2c_num].hw_enabled = true;\r\n    }\r\n    I2C_EXIT_CRITICAL(&(i2c_context[i2c_num].spinlock));\r\n}\r\n\r\nstatic inline void i2c_ll_enable_bus_clock(int i2c_port, bool enable)\r\n{\r\n    if (i2c_port == 0) {\r\n        SYSTEM.perip_clk_en0.i2c_ext0_clk_en = enable;\r\n    } else if (i2c_port == 1) {\r\n        SYSTEM.perip_clk_en0.i2c_ext1_clk_en = enable;\r\n    }\r\n}\r\n\r\n/// use a macro to wrap the function, force the caller to use it in a critical section\r\n/// the critical section needs to declare the __DECLARE_RCC_ATOMIC_ENV variable in advance\r\n#define i2c_ll_enable_bus_clock(...) do {(void)__DECLARE_RCC_ATOMIC_ENV; i2c_ll_enable_bus_clock(__VA_ARGS__);} while(0)\r\n\n"})}),"\n",(0,_.jsx)(n.p,{children:"\u6240\u4ee5\u5173\u952e\u5c31\u5728\u4e8e \u662f\u5728\u590d\u4f4d\u5916\u8bbe\u7684\u8fc7\u7a0b\u4e2d\u628a\u65f6\u949f\u9891\u7387\u7684\u914d\u7f6e\u4fe1\u606f\u7ed9\u6e05\u9664\u4e86\u3002"}),"\n",(0,_.jsx)(n.h2,{id:"\u89e3\u51b3\u8fc7\u7a0b",children:"\u89e3\u51b3\u8fc7\u7a0b\uff1a"}),"\n",(0,_.jsxs)(n.p,{children:["\u5728",(0,_.jsx)(n.code,{children:"i2c_hw_disable"}),"\u7684\u65f6\u5019\uff0c\u4e0d\u53bb\u590d\u4f4d\u5916\u8bbe\uff0c\u800c\u662f\u53bb\u6e05\u9664\u5916\u8bbe\uff1a"]}),"\n",(0,_.jsx)(n.pre,{children:(0,_.jsx)(n.code,{className:"language-c",children:"static inline void periph_i2c_disable_clk_set_rst(periph_module_t periph)\r\n{\r\n    DPORT_CLEAR_PERI_REG_MASK(periph_ll_get_clk_en_reg(periph), periph_ll_get_clk_en_mask(periph));\r\n    DPORT_CLEAR_PERI_REG_MASK(periph_ll_get_rst_en_reg(periph), periph_ll_get_rst_en_mask(periph, false));\r\n}\n"})}),"\n",(0,_.jsx)(n.p,{children:(0,_.jsx)(n.img,{src:r(5424).A+"",width:"1199",height:"277"})}),"\n",(0,_.jsx)(n.p,{children:(0,_.jsx)(n.a,{target:"_blank","data-noBrokenLinkCheck":!0,href:r(1397).A+"",children:"i2c_patch"})})]})}function d(e={}){const{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,_.jsx)(n,{...e,children:(0,_.jsx)(a,{...e})}):a(e)}},1397:(e,n,r)=>{r.d(n,{A:()=>_});const _=r.p+"assets/files/i2c_change-cc0381e098db4bf9af80c7b7c0d514d8.patch"},8270:(e,n,r)=>{r.d(n,{A:()=>_});const _=r.p+"assets/images/i2c_frequency-c18e31fa86d544fb23a68b1e18bf3837.png"},5406:(e,n,r)=>{r.d(n,{A:()=>_});const _=r.p+"assets/images/i2c_frequency_40khz-b267f0785c51a5f3b6cede594e844f9f.png"},8557:(e,n,r)=>{r.d(n,{A:()=>_});const _=r.p+"assets/images/i2c_frequency_5khz-250accd911282d9a60685821c8cb7083.png"},5424:(e,n,r)=>{r.d(n,{A:()=>_});const _=r.p+"assets/images/i2c_frequency_result-1c21616b62f143eb993c4e91796e4845.png"},8453:(e,n,r)=>{r.d(n,{R:()=>l,x:()=>s});var _=r(6540);const i={},c=_.createContext(i);function l(e){const n=_.useContext(c);return _.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function s(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:l(e.components),_.createElement(c.Provider,{value:n},e.children)}}}]);