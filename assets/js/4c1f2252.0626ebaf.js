"use strict";(self.webpackChunkmy_website=self.webpackChunkmy_website||[]).push([[4860],{7857:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>o,contentTitle:()=>c,default:()=>a,frontMatter:()=>_,metadata:()=>i,toc:()=>l});var r=s(4848),t=s(8453);const _={},c="USB HOST MSC",i={id:"espressif/\u4e2a\u4eba\u5b66\u4e60/\u5916\u8bbe/USB/usb_host_msc",title:"USB HOST MSC",description:"\u505ahost_msc\u6709\u4e00\u4e2a\u7ec4\u4ef6",source:"@site/docs/espressif/\u4e2a\u4eba\u5b66\u4e60/\u5916\u8bbe/USB/usb_host_msc.md",sourceDirName:"espressif/\u4e2a\u4eba\u5b66\u4e60/\u5916\u8bbe/USB",slug:"/espressif/\u4e2a\u4eba\u5b66\u4e60/\u5916\u8bbe/USB/usb_host_msc",permalink:"/docs/espressif/\u4e2a\u4eba\u5b66\u4e60/\u5916\u8bbe/USB/usb_host_msc",draft:!1,unlisted:!1,editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/espressif/\u4e2a\u4eba\u5b66\u4e60/\u5916\u8bbe/USB/usb_host_msc.md",tags:[],version:"current",frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"USB HOST HID",permalink:"/docs/espressif/\u4e2a\u4eba\u5b66\u4e60/\u5916\u8bbe/USB/usb_host_hid"},next:{title:"USB\u534f\u8bae\u5c42\u6570\u636e\u683c\u5f0f\uff08\u4e8b\u52a1\u3001\u5305\u3001\u57df\uff09",permalink:"/docs/espressif/\u4e2a\u4eba\u5b66\u4e60/\u5916\u8bbe/USB/usb\u534f\u8bae\u5c42\u6570\u636e\u683c\u5f0f"}},o={},l=[{value:"1.\u7ec4\u4ef6\u505ahost msc\u7684\u6d41\u7a0b",id:"1\u7ec4\u4ef6\u505ahost-msc\u7684\u6d41\u7a0b",level:3},{value:"1.\u521d\u59cb\u5316usb host",id:"1\u521d\u59cb\u5316usb-host",level:4},{value:"2.msc\u914d\u7f6e",id:"2msc\u914d\u7f6e",level:3},{value:"3.\u9876\u5c42task",id:"3\u9876\u5c42task",level:3}];function d(e){const n={code:"code",h1:"h1",h3:"h3",h4:"h4",li:"li",ol:"ol",p:"p",pre:"pre",...(0,t.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.h1,{id:"usb-host-msc",children:"USB HOST MSC"}),"\n",(0,r.jsx)(n.p,{children:"\u505ahost_msc\u6709\u4e00\u4e2a\u7ec4\u4ef6"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"espressif/usb_host_msc\n"})}),"\n",(0,r.jsx)(n.h3,{id:"1\u7ec4\u4ef6\u505ahost-msc\u7684\u6d41\u7a0b",children:"1.\u7ec4\u4ef6\u505ahost msc\u7684\u6d41\u7a0b"}),"\n",(0,r.jsx)(n.h4,{id:"1\u521d\u59cb\u5316usb-host",children:"1.\u521d\u59cb\u5316usb host"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsx)(n.li,{children:"\u914d\u7f6ephy"}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-c",children:"usb_phy_config_t phy_config = {\r\n    .controller = USB_PHY_CTRL_OTG,\r\n    .target = USB_PHY_TARGET_INT, // \u5185\u90e8Phy\r\n    .otg_mode = USB_OTG_MODE_HOST,\r\n    .otg_speed = USB_PHY_SPEED_UNDEFINED, // \u53d6\u51b3\u4e8e\u8bbe\u5907\u901f\u5ea6\r\n};\r\nESP_ERROR_CHECK(usb_new_phy(&phy_config, &phy_hdl));\n"})}),"\n",(0,r.jsxs)(n.ol,{start:"2",children:["\n",(0,r.jsx)(n.li,{children:"\u5b89\u88c5\u9a71\u52a8"}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-c",children:"const usb_host_config_t host_config = {\r\n    .skip_phy_setup = true,\r\n    .intr_flags = ESP_INTR_FLAG_LEVEL1,\r\n};\r\nESP_ERROR_CHECK(usb_host_install(&host_config));\n"})}),"\n",(0,r.jsx)(n.p,{children:"\u5176\u4e2d\uff0c\u6211\u4eec\u4e0a\u9762\u624b\u52a8\u914d\u7f6e\u4e86phy\uff0c\u6240\u4ee5skip_phy_setup\u8981\u8bbe\u7f6e\u4e3atrue"}),"\n",(0,r.jsxs)(n.ol,{start:"3",children:["\n",(0,r.jsx)(n.li,{children:"\u5f00\u542f\u56de\u8c03\u4efb\u52a1"}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-c",children:'void usb_host_handle_events(void *args)\r\n{\r\n    uint32_t end_flags = 0;\r\n    while (1)\r\n    {\r\n        uint32_t event_flags = 0;\r\n        usb_host_lib_handle_events(portMAX_DELAY, &event_flags); // \u7b49\u5f85\u4e8b\u4ef6\r\n        if (event_flags & USB_HOST_LIB_EVENT_FLAGS_NO_CLIENTS)\r\n        {\r\n            // \u6240\u6709\u5ba2\u6237\u7aef\u5747\u88ab\u6ce8\u9500\r\n            ESP_LOGI(TAG, "USB_HOST_LIB_EVENT_FLAGS_NO_CLIENTS");\r\n            usb_host_device_free_all();\r\n            end_flags |= 1;\r\n        }\r\n\r\n        if (event_flags & USB_HOST_LIB_EVENT_FLAGS_ALL_FREE)\r\n        {\r\n            //\u4e8b\u4ef6\u91ca\u653e\r\n            ESP_LOGI(TAG, "USB_HOST_LIB_EVENT_FLAGS_ALL_FREE");\r\n            end_flags |= 2;\r\n        }\r\n\r\n        if (end_flags == 3)\r\n        {\r\n            xSemaphoreGive(ready_to_deinit_usb);\r\n            break;\r\n        }\r\n    }\r\n    vTaskDelete(NULL);\r\n}\n'})}),"\n",(0,r.jsx)(n.p,{children:"\u8fd9\u91cc\u6709\u4e00\u4e2a\u597d\u73a9\u7684\u64cd\u4f5c\uff0c\u53ea\u6709\u5ba2\u6237\u7aef\u88ab\u6ce8\u9500\u4ee5\u53caUSB\u4e8b\u4ef6\u88ab\u91ca\u653e\u540e\uff0cend_flags\u4f1a\u52303\uff0c\u6b64\u65f6\u76f4\u63a5deinit usb"}),"\n",(0,r.jsx)(n.h3,{id:"2msc\u914d\u7f6e",children:"2.msc\u914d\u7f6e"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-c",children:"const msc_host_driver_config_t msc_config = {\r\n    .create_backround_task = true,\r\n    .callback = usb_host_msc_event_cb,\r\n    .stack_size = 4096,\r\n    .task_priority = 5,\r\n};\r\nESP_ERROR_CHECK(msc_host_install(&msc_config));\n"})}),"\n",(0,r.jsx)(n.p,{children:"\u5176\u4e2d\u9700\u8981\u6ce8\u610f\u7684\u5c31\u662fmsc\u7684event\u56de\u8c03\uff0c\u4e3b\u8981\u662f\u901a\u8fc7\u5c06\u961f\u5217\u5c06event\u53d1\u9001\u51fa\u53bb"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-c",children:'void usb_host_msc_event_cb(const msc_host_event_t *event, void *arg)\r\n{\r\n    if (event->event == MSC_DEVICE_CONNECTED)\r\n    {\r\n        ESP_LOGI(TAG, "MSC Device Connected"); // \u8bbe\u5907\u8fde\u63a5\r\n    }\r\n    else\r\n    {\r\n        ESP_LOGI(TAG, "MSC Device Disconnected"); // \u8bbe\u5907\u65e0\u8fde\u63a5\r\n    }\r\n\r\n    // \u961f\u5217\u53d1\u9001\u4e8b\u4ef6\r\n    xQueueSend(app_queue, event, 10);\r\n}\n'})}),"\n",(0,r.jsx)(n.h3,{id:"3\u9876\u5c42task",children:"3.\u9876\u5c42task"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-c",children:'void msc_task(void *args)\r\n{\r\n    while (1)\r\n    {\r\n        // \u7b49\u5f85\u8bbe\u5907\u8fde\u63a5\r\n        msc_host_event_t msc_event;\r\n        xQueueReceive(app_queue, &msc_event, portMAX_DELAY);\r\n        if (msc_event.event == MSC_DEVICE_CONNECTED)\r\n        {\r\n            // \u83b7\u53d6MSC\u8bbe\u5907\u5730\u5740\r\n            uint8_t device_addr = msc_event.device.address;\r\n            // \u521d\u59cb\u5316MSC\u8bbe\u5907\r\n            ESP_ERROR_CHECK(msc_host_install_device(device_addr, &device));\r\n            // \u6302\u8f7d\u865a\u62df\u6587\u4ef6\u7cfb\u7edf\r\n            ESP_ERROR_CHECK(msc_host_vfs_register(device, "/usb", &mount_config, &vfs_handle));\r\n            ESP_LOGI(TAG, "USB VFS Done");\r\n\r\n            // \u626b\u63cf\u6240\u6709\u6587\u4ef6\r\n            DIR *dir = opendir("/usb");\r\n            if (dir != NULL)\r\n            {\r\n                struct dirent *entry;\r\n                while ((entry = readdir(dir)) != NULL)\r\n                {\r\n                    ESP_LOGI(TAG, "%s has file:%s", "/usb", entry->d_name);\r\n                }\r\n            }\r\n            else\r\n            {\r\n                break;\r\n            }\r\n        }\r\n        else\r\n        {\r\n            ESP_ERROR_CHECK(msc_host_vfs_unregister(vfs_handle));\r\n            ESP_ERROR_CHECK(msc_host_uninstall_device(device));\r\n        }\r\n    }\r\n\r\n    ESP_ERROR_CHECK(msc_host_vfs_unregister(vfs_handle));\r\n    ESP_ERROR_CHECK(msc_host_uninstall_device(device));\r\n    vTaskDelete(NULL);\r\n}\n'})})]})}function a(e={}){const{wrapper:n}={...(0,t.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(d,{...e})}):d(e)}},8453:(e,n,s)=>{s.d(n,{R:()=>c,x:()=>i});var r=s(6540);const t={},_=r.createContext(t);function c(e){const n=r.useContext(_);return r.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function i(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:c(e.components),r.createElement(_.Provider,{value:n},e.children)}}}]);