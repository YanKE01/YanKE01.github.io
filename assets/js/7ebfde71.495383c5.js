"use strict";(self.webpackChunkmy_website=self.webpackChunkmy_website||[]).push([[3150],{7248:(e,r,n)=>{n.r(r),n.d(r,{assets:()=>l,contentTitle:()=>s,default:()=>c,frontMatter:()=>a,metadata:()=>o,toc:()=>d});var t=n(4848),i=n(8453);const a={},s="TFLITE CIFAR10",o={id:"espressif/\u4e2a\u4eba\u5b66\u4e60/DL/tflite_2d",title:"TFLITE CIFAR10",description:"\u6a21\u578b\u642d\u5efa",source:"@site/docs/espressif/\u4e2a\u4eba\u5b66\u4e60/DL/tflite_2d.md",sourceDirName:"espressif/\u4e2a\u4eba\u5b66\u4e60/DL",slug:"/espressif/\u4e2a\u4eba\u5b66\u4e60/DL/tflite_2d",permalink:"/docs/espressif/\u4e2a\u4eba\u5b66\u4e60/DL/tflite_2d",draft:!1,unlisted:!1,editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/espressif/\u4e2a\u4eba\u5b66\u4e60/DL/tflite_2d.md",tags:[],version:"current",frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"TFLite 1DCNN",permalink:"/docs/espressif/\u4e2a\u4eba\u5b66\u4e60/DL/tflite_1dcnn"},next:{title:"TFLite Micro Regression",permalink:"/docs/espressif/\u4e2a\u4eba\u5b66\u4e60/DL/tflite_micro_regression"}},l={},d=[{value:"\u6a21\u578b\u642d\u5efa",id:"\u6a21\u578b\u642d\u5efa",level:2},{value:"ESP32\u63a8\u7406",id:"esp32\u63a8\u7406",level:2},{value:"PC\u7aefJPG\u56fe\u7247\u8f6c\u6362\u4e3a\u6570\u7ec4",id:"pc\u7aefjpg\u56fe\u7247\u8f6c\u6362\u4e3a\u6570\u7ec4",level:3},{value:"esp_jpeg\u89e3\u7801jpg",id:"esp_jpeg\u89e3\u7801jpg",level:2}];function p(e){const r={code:"code",em:"em",h1:"h1",h2:"h2",h3:"h3",img:"img",p:"p",pre:"pre",...(0,i.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(r.h1,{id:"tflite-cifar10",children:"TFLITE CIFAR10"}),"\n",(0,t.jsx)(r.h2,{id:"\u6a21\u578b\u642d\u5efa",children:"\u6a21\u578b\u642d\u5efa"}),"\n",(0,t.jsx)(r.p,{children:"\u6570\u636e\u96c6\u5904\u7406"}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-python",children:"from keras.datasets import cifar10\r\nfrom keras.preprocessing.image import ImageDataGenerator\r\nfrom keras.models import Sequential, load_model, Model\r\nfrom keras.layers import Input, Dense, Dropout, Activation, Flatten\r\nfrom keras.layers import Convolution2D, MaxPooling2D, GlobalAveragePooling2D\r\nimport pandas as pd\r\nimport matplotlib.pyplot as plt\r\nimport time, pickle\r\nfrom keras.utils import to_categorical\r\nfrom keras import layers\r\nimport tensorflow as tf\r\nfrom tensorflow.keras.callbacks import EarlyStopping\r\n\r\n(x_train, y_train), (x_test, y_test) = cifar10.load_data()\r\n\r\ny_train = y_train.reshape(y_train.shape[0])\r\ny_test = y_test.reshape(y_test.shape[0])\r\n\r\nprint('x_train shape:', x_train.shape)\r\nprint(x_train.shape[0], 'training samples')\r\nprint(x_test.shape[0], 'validation samples')\r\n\r\nx_train = x_train.astype('float32')\r\nx_test = x_test.astype('float32')\r\nx_train /= 255\r\nx_test /= 255\r\n\r\ny_train = to_categorical(y_train, 10)\r\ny_test = to_categorical(y_test, 10)\r\n\n"})}),"\n",(0,t.jsx)(r.p,{children:"\u6a21\u578b\u642d\u5efa"}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-python",children:"def build_model():\r\n    model = tf.keras.Sequential()\r\n    model.add(layers.Conv2D(32, kernel_size=(4,4), strides=1,activation='relu', input_shape=(32, 32, 3)))\r\n    model.add(layers.MaxPooling2D((2, 2)))\r\n\r\n    model.add(layers.Conv2D(32, kernel_size=(4,4), strides=1,activation='relu'))\r\n    model.add(layers.MaxPooling2D((2, 2)))\r\n\r\n\r\n    model.add(layers.Flatten())\r\n    model.add(layers.Dense(256, activation='relu'))\r\n    model.add(layers.Dense(10, activation='softmax'))\r\n\r\n    print(model.summary())\r\n    return model\r\n\r\nmodel=build_model()\n"})}),"\n",(0,t.jsx)(r.p,{children:"tflite\u6a21\u578b\u8f6c\u6362"}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-python",children:'\r\nconverter = tf.lite.TFLiteConverter.from_keras_model(model)\r\ntflite_model = converter.convert()\r\nopen("cifar10.tflite", "wb").write(tflite_model)\n'})}),"\n",(0,t.jsx)(r.h2,{id:"esp32\u63a8\u7406",children:"ESP32\u63a8\u7406"}),"\n",(0,t.jsx)(r.p,{children:"\u672c\u6587\u91c7\u7528\u7684\u662f2DCNN\uff0c\u6dfb\u52a0\u6240\u9700\u7684op\u7b97\u5b50\u5373\u53ef"}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-c",children:'static tflite::MicroMutableOpResolver<5> resolver;\r\n// \u8fd9\u91cc\u9700\u8981\u6dfb\u52a0\u6211\u4eec\u6a21\u578b\u4f7f\u7528\u7684\u5c42\r\nif (resolver.AddReshape() != kTfLiteOk)\r\n{\r\n    ESP_LOGI(TAG, "Add reshape failed");\r\n    return;\r\n}\r\n\r\nif (resolver.AddConv2D() != kTfLiteOk)\r\n{\r\n    ESP_LOGI(TAG, "Add reshape failed");\r\n    return;\r\n}\r\n\r\nif (resolver.AddMaxPool2D() != kTfLiteOk)\r\n{\r\n    ESP_LOGI(TAG, "Add reshape failed");\r\n    return;\r\n}\r\n\r\nif (resolver.AddFullyConnected() != kTfLiteOk)\r\n{\r\n    ESP_LOGI(TAG, "Add reshape failed");\r\n    return;\r\n}\r\n\r\nif (resolver.AddSoftmax() != kTfLiteOk)\r\n{\r\n    ESP_LOGI(TAG, "Add reshape failed");\r\n    return;\r\n}\n'})}),"\n",(0,t.jsx)(r.h3,{id:"pc\u7aefjpg\u56fe\u7247\u8f6c\u6362\u4e3a\u6570\u7ec4",children:"PC\u7aefJPG\u56fe\u7247\u8f6c\u6362\u4e3a\u6570\u7ec4"}),"\n",(0,t.jsx)(r.p,{children:"\u6bcf\u4e00\u4e2a\u50cf\u7d20\u70b9\u90fd\u6709RGB\u4e09\u4e2a\u6570\u503c\uff0c\u4f9d\u6b21\u6392\u5f00\u5373\u53ef\uff0c\u4ee5\u4e0b\u4e3apython\u7684\u4e00\u6bb5\u5b9e\u4f8b"}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-python",children:'from PIL import Image\r\nimport numpy as np\r\n\r\ndef image_to_c_array(image_path):\r\n    # \u8bfb\u53d6\u56fe\u7247\r\n    image = Image.open(image_path)\r\n\r\n    print(image.size)\r\n    # \u8f6c\u6362\u4e3anumpy\u6570\u7ec4\r\n    image_array = np.array(image)\r\n\r\n\r\n    # \u5f52\u4e00\u5316\r\n    # normalized_image_array = image_array / 255.0\r\n    print(image_array.size)\r\n    x_array_flatten = image_array.flatten()\r\n    print(len(x_array_flatten))\r\n    c_array_string = "{" + ", ".join(str(pixel) for pixel in x_array_flatten) + "}"\r\n\r\n    with open("image_array.h", "w") as f:\r\n        f.write("#ifndef IMAGE_ARRAY_H\\n")\r\n        f.write("#define IMAGE_ARRAY_H\\n\\n")\r\n        f.write("const float image_array[] = %s;\\n" % c_array_string)\r\n        f.write("#endif\\n")\r\n\r\n\r\n# \u8c03\u7528\u51fd\u6570\u751f\u6210.h\u6587\u4ef6\r\nimage_to_c_array("0042.jpg")\n'})}),"\n",(0,t.jsx)(r.p,{children:(0,t.jsx)(r.img,{src:n(9859).A+"",width:"2610",height:"578"})}),"\n",(0,t.jsx)(r.h2,{id:"esp_jpeg\u89e3\u7801jpg",children:"esp_jpeg\u89e3\u7801jpg"}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-c",children:'size_t pic_buf_size = 32 * 32 * sizeof(uint32_t);\r\n        uint8_t *pic_buf = (uint8_t *)heap_caps_malloc(pic_buf_size + 1, MALLOC_CAP_SPIRAM); // create out image buffer\r\n        esp_jpeg_image_cfg_t jpeg_cfg = {\r\n            .indata = (uint8_t *)file_buf,\r\n            .indata_size = filesize,\r\n            .outbuf = (uint8_t *)pic_buf,\r\n            .outbuf_size = pic_buf_size,\r\n            .out_format = JPEG_IMAGE_FORMAT_RGB888,\r\n            .out_scale = JPEG_IMAGE_SCALE_0,\r\n        };\r\n\r\n        // // decode jpg\r\n        esp_jpeg_image_output_t outimage;\r\n        esp_jpeg_decode(&jpeg_cfg, &outimage);\r\n        ESP_LOGI(TAG, "%s size: %d x %d", filename, outimage.width, outimage.height);\n'})}),"\n",(0,t.jsx)(r.p,{children:"\u548c\u4e0a\u9762python\u7248\u672c\u7684\u4e00\u6837\uff0c\u89e3\u7801\u51fa\u6765\u7684pic_buf\u5b58\u653e\u7684\u4e5f\u662f\u6bcf\u4e00\u4e2a\u7684\u50cf\u7d20\uff0c\u7c7b\u4f3c\u4e8e\u8fd9\u6837"}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-c",children:"pic_buf[]= {\u50cf\u7d200\u7684R\uff0c\u50cf\u7d200\u7684G\uff0c\u50cf\u7d200\u7684B\uff0c\u50cf\u7d201\u7684R....}\n"})}),"\n",(0,t.jsxs)(r.p,{children:["\u6240\u4ee5\u5728\u8f93\u5165\u7f51\u7edc\u7684\u65f6\u5019\uff0cpic_buf\u7684\u957f\u5ea6\u4e00\u5b9a\u662f\u56fe\u50cf\u5bbd",(0,t.jsx)(r.em,{children:"\u56fe\u50cf\u9ad8"}),"3\uff0c\u5176\u4e2d3\u4e3aRGB\uff0c\u5305\u62ec\u89e3\u7801\u7684\u65f6\u5019\u9009\u62e9RGB888"]}),"\n",(0,t.jsx)(r.p,{children:"\u63a8\u7406\u7aef\u7684\u4ee3\u7801,\u8bb0\u5f97\u5f52\u4e00\u5316"}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-c",children:'void cifar10_model_predict(const uint8_t *pic, int size)\r\n{\r\n    for (int i = 0; i < size; i++)\r\n    {\r\n        input->data.f[i] = pic[i] / 255.0f;\r\n    }\r\n\r\n    TfLiteStatus invoke_status = interpreter->Invoke();\r\n    if (invoke_status != kTfLiteOk)\r\n    {\r\n        MicroPrintf("Invoke failed on");\r\n        return;\r\n    }\r\n\r\n    for (int i = 0; i < 10; i++)\r\n    {\r\n        printf("%.2f ", output->data.f[i]);\r\n    }\r\n    printf("\\n");\r\n}\n'})})]})}function c(e={}){const{wrapper:r}={...(0,i.R)(),...e.components};return r?(0,t.jsx)(r,{...e,children:(0,t.jsx)(p,{...e})}):p(e)}},9859:(e,r,n)=>{n.d(r,{A:()=>t});const t=n.p+"assets/images/jpg_to_array-e8cc33f79018ee7de4277ccec3525595.png"},8453:(e,r,n)=>{n.d(r,{R:()=>s,x:()=>o});var t=n(6540);const i={},a=t.createContext(i);function s(e){const r=t.useContext(a);return t.useMemo((function(){return"function"==typeof e?e(r):{...r,...e}}),[r,e])}function o(e){let r;return r=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:s(e.components),t.createElement(a.Provider,{value:r},e.children)}}}]);